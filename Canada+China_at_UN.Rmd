---
title: "Canada and China's performance at the UN"
author: "François-Philippe Dubé"
date: "14/02/2021"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
# Charger les bibilothèques du projet
# devtools::install_github("dgrtwo/unvotes") # Ne faire qu'une seule fois
library(ProjectTemplate)
load.project() # Intègre toutes les définitions de bibliothèques de cette analyse

# Define options
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=8) 
theme_set(theme_minimal()) # Définit le thème utilisé pour les graphiques

# Télécharger une base de données d'indicateurs de la Banque mondiale
# new_cache <- wb_cache() # Ne faire qu'une seule fois
# cache("new_cache") # Ne faire qu'une seule fois
```

Description et exploration visuelle des données
=================================================

Le chercheur Erik Voeten maintien une base de données des votes à l'Assemblée générale des Nations Unies (AGNU).  

> Erik Voeten "Data and Analyses of Voting in the UN General Assembly," *Routledge Handbook of International Organization*, edited by Bob Reinalda (publié le 27 mai 2013), disponible à SSRN: http://ssrn.com/abstract=2111149.

Cette base de données est présevée sur le [*dataverse* de l'Université Harvard](https://dataverse.harvard.edu/dataset.xhtml?persistentId=hdl:1902.1/12379), avec le livre de codes associé expliquant les variables utilisées.

Chaque résolution est associée à un ou plusieurs enjeux particuliers:

- Moyen-Orient
- Nucléaire
- Désarmement
- Droits de la personne
- Colonialisme
- Développement économique

Nous y avons rajouté une septième catégorie, "Autre", pour identifier les résolutions n'entrant dans aucune des catégories ci-dessus. 

> *À Noter*: Le paquet **R** `un_votes` sur le dépôt du CRAN a été tiré d'une version antérieure cette base de données. Nous lui avons préféré la base de données du dépôt de Harvard, et ce, en dépit du fait qu'elle requiert plus de manipulations, pour deux raisons. D'abord, elle est plus à jour et couvre jusqu'à 2019 (alors que celle du paquet ne couvre que jusqu'à 2015). Ensuite, le codage des enjeux a été fait différemment, permettant la possibilité qu'une résolution couvre plus qu'un enjeu ou qu'elle n'en couvre aucun -- ce qui est plus réaliste.

Voici un échantillon du tableau `onu_large`. 

```{r manip_complete_votes}
# Télécharger la base de données -- ne faire qu'une seule fois
# download.file("https://dataverse.harvard.edu/api/access/datafile/:persistentId?persistentId=doi:10.7910/DVN/LEJUQZ/MLNAHB", "./data/onu_votes.RData")
# load("./data/onu_votes.RData")

# Pour passer les enjeux en boucle, on va transformer le jeu de données onu en format "long"

# Recoder certaines valeurs et renommer les variables d'enjeux et de pays
onu_large <- completeVotes %>% 
  mutate(vote_long = factor(vote, labels = c("Pour", "Abstention", "Contre", "Absent", "Non membre"))) %>% 
  rename(moyen_orient = me, 
         nucleaire = nu, 
         desarmement = di, 
         droit_pers = hr, 
         colonialisme = co, 
         dev_econ = ec, 
         pays = Country, 
         pays_long = Countryname) %>% 
  
  # On ajoute un enjeu "autre" 
  mutate(nb_enjeux = (moyen_orient + 
                     nucleaire +
                     desarmement +
                     droit_pers +
                     colonialisme +
                     dev_econ), 
         autre = if_else(nb_enjeux == 0, 1, 0)) %>% 
  
  # On enlève les "votes" des non-membres et les résolutions identiques (3%)
  filter(vote != 9 & ident == 0) %>% 
  
  # On mesure la proportion de votes "en faveur" des résolutions de l'AGNU tous
  # enjeux confondus par pays par année.
   group_by(year = year(date), pays) %>% 
  mutate(prop_oui = mean(vote_long == "Pour")) %>%
  ungroup() %>% 

  # On reformate le tableau le tableau en y enlevant les variables redondantes
  select(resid, vote, vote_long, year, prop_oui, importantvote, short, descr, moyen_orient, nucleaire, 
         desarmement, droit_pers, colonialisme, dev_econ, autre, nb_enjeux, 
         everything(),
         -rcid, -amend, -member, -ccode, -ident) 
  
```

Le tableau fait maintenant `r dim(onu_large)[1]` rangées par  `r dim(onu_large)[2]` colonnes.

On en fait également une autre version, plus compacte, décrivant les enjeux au format long (`onu`). 
```{r onu_long}

# Définition des enjeux: on va les passer en boucle
enjeux <- tibble(court = c("autre", 
                           "colonialisme", 
                           "desarmement", 
                           "dev_econ", 
                           "droit_pers", 
                           "moyen_orient", 
                           "nucleaire"), 
  long = c("Autre", 
           "Colonialisme", 
           "Désarmement", 
           "Développement économique", 
           "Droits de la personne", 
           "Moyen-Orient", 
           "Nucléaire"))



onu <- onu_large %>% 
  pivot_longer(cols = all_of(enjeux[[1]]), names_to = "enjeux", values_to = "valeur") %>% 
  filter(valeur == 1) %>% select(resid, year, enjeux, pays, pays_long, everything(), -valeur)

onu %>% slice_sample(n = 3) %>% kable()

```


Définitions - Quelques groupes de pays
======================================

Pour l'analyse, nous allons définir certains groupements de pays: G7, G20, pays en développement (séparés en pays à revenus faibles ou moyens), Afrique subsaharienne.

```{r definitions_pays}
# Dans cette section, on crée des "vecteurs" contenant différents regroupements de pays

g7 <- c("Canada", "France", "Germany", "Italy", "Japan", "United Kingdom", 
        "United States") %>%
  countrycode(., origin = "country.name", destination = "iso3c")

g20 <- c("Argentina", "Australia", "Brazil", "Canada", 'China', "France", "Germany", "India", "Indonesia", "Italy", "Japan", "Mexico", "Netherlands", "Russia", "Saudi Arabia", "Singapore", "South Africa", "South Korea", "Spain", "Switzerland", "Turkey", "United Kingdom", "United States") %>% countrycode(., origin = "country.name", destination = "iso3c")

# Pour l'Afrique sub-saharienne, on utilise la base de données du paquet countrycode
afr <- countrycode::codelist_panel %>% 
  filter(year == 2020 & region == "Sub-Saharan Africa" & !is.na(iso3c)) %>% 
  pull(iso3c) # dplyr::pull permet de retourner un vecteur

# Pour les pays en développement, on génère un tableau de la 
# Banque mondiale et on en extrait les pays en développement (il y en a 218)
pays <- wb_countries() %>% 
  filter(income_level != "Aggregates") %>% 
  select(-c(capital_city, contains("_iso2c"), contains("admin_")))
  
# Les pays en développement -- on en fait des vecteurs
dev <- pays %>% filter(income_level_iso3c != "HIC") %>% pull("iso3c")
lic <- pays %>% filter(income_level_iso3c == "LIC") %>% pull("iso3c")
lmic <- pays %>% filter(income_level_iso3c == "LMC") %>% pull("iso3c")
umic <- pays %>% filter(income_level_iso3c == "UIC") %>% pull("iso3c")
```


Analyse - Partie 1: Évolution de la position du Canada à l'ONU 
==============================================================

Comme on peut le voir ci-dessous, *tous enjeux confondus*, le Canada vote de manière plus conservatrice que presque tous les pays du G7 à l'ONU, à l'exception des États-Unis. La Chine vote en faveur des résolutions de l'AGNU beaucoup plus fréquemment que les pays du G7.

```{r position_can_us_zh, fig.height=6, fig.width=8}
# # Note méthodologique: pour mesurer la proportion de votes "en faveur" des
# motions de l'AGNU tous enjeux confondus, on doit utiliser onu_large, puisque
# "onu" (au format long) a un nombre variable d'enjeux (et donc de lignes) pour
# chaque résolution qui fausse le calcul des proportions. Nous avons déjà
# calculé cette proportion plus haut.
#
# # Cependant, pour mesurer la proportion de votes "en faveur" *en désagrégeant
# par enjeu*, peut sans problème partir du jeu de données "onu", profitant ainsi
# du fait que les enjeux sont maintenant des niveaux de la variable "enjeux", ce
# qui de facetter facilement le graphique. Il faut alors *transmuter* "prop_oui"
# en le recalculant pour chaque enjeu filtré.


onu_large %>% 
  group_by(year = year(date), pays) %>% 
  filter( year > 1989 & pays %in% c(g7, "CHN")) %>% 
  ggplot(aes(x = year, y = prop_oui, color = pays)) +
    geom_line(size = 1.5, alpha = 0.5) +
    ylab('proportion des votes "en faveur"') +
  xlab("année") +
  ggtitle("La Chine vote plus souvent en faveur des résolutions de l'AGNU",
          "Le Canada est plus consverateur à l'ONU que les autres pays du G7") +
  theme_economist_white() +
  gghighlight() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "none")

```

Cette situation change-t-elle en fonction des enjeux?

```{r, fig.width=8, fig.height=16}
# À faire: faire une fonction avec filtre = enjeux et facette par enjeux

# Définition d'un jeu de données plus restreint 
onu_enjeux <- onu_large %>% 
  group_by(year = year(date), pays) %>% 
  filter( year > 1989 & pays %in% c(g7, "CHN")) %>% 
  mutate(prop_oui = mean(vote_long == "Pour"))


# Définition d'une fonction graphique générique -- source:
# https://stackoverflow.com/questions/4856849/looping-over-variables-in-ggplot, 
# answered Aug 27 '18 at 19:10 by Tung

fonction <- function(df, .enjeu){
  df %>% 
    filter(!! sym(.enjeu) == 1) %>% 
    group_by(year = year(date), pays) %>% 
    mutate(prop_oui = mean(vote_long == "Pour")) %>% 
    ungroup() %>% 
    ggplot(aes(year, prop_oui, colour = pays)) +
    geom_line() +
    gghighlight(use_direct_label = FALSE) +
    xlab("") +
    ylab("Prop. annuelle de votes 'oui'") +
#    ggtitle(label = sym(.enjeu)) +
    facet_wrap(~ pays, scales = "free_x", ncol = 4, nrow = 2) +
    theme_few() +
    theme(legend.position = "none") +
    theme(strip.text = element_text(hjust = 1)) +
    theme(strip.placement = "outside") 
}

graphes_g7 <- map(~ fonction(df = onu_enjeux, .enjeu = .x), .x = enjeux$court[2:7])
cowplot::plot_grid(plotlist = graphes_g7, nrow = 6, ncol = 1, labels = as.list(enjeux$long[2:7]))

```